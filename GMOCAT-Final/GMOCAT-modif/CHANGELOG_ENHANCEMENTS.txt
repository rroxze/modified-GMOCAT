GMOCAT Enhancement Report
=========================

This document details the modifications made to the original GMOCAT codebase to implement Coverage-Aware Reward, Uncertainty-Based Termination, and Adaptive Diversity Weight.

1. Environment Modifications (GMOCAT-modif/envs/GCATEnv.py)
-----------------------------------------------------------
*   **Coverage-Aware Reward:**
    *   Added `load_concept_importance()`: Loads the concept graph structure (`K_Directed.txt`) to calculate node importance based on degree centrality.
    *   Updated `compute_div_reward()`: Replaced the original binary reward with a continuous calculation.
        *   New formula: `Reward = Sum(Concept Importance) * (1.0 + Coverage Deficit)`
        *   This incentivizes selecting questions that cover important, unmastered concepts, weighted more heavily when overall coverage is low.
    *   Updated `reset_with_users()` and `step()`: Now initializes and updates concept uncertainty tracking if available from the model.

*   **Logic Fixes:**
    *   Corrected the logic in the concept consistency check loop (previously iterating over `zip` with mismatched dimensions/logic).
    *   Added safe division checks for coverage calculation to prevent division by zero.

2. Model Modifications (GMOCAT-modif/envs/ncd.py)
-------------------------------------------------
*   **Uncertainty-Based Termination:**
    *   Added `estimate_concept_uncertainty()`: Implements Monte Carlo (MC) Dropout. It runs the model multiple times (default n=5) in training mode (dropout enabled) to estimate the predictive variance for each concept.
    *   Updated `get_knowledge_status()`: Modified to return both the mean mastery score (student embedding) and the estimated uncertainty (variance).
*   **Device Compatibility:**
    *   Changed `self.device = torch.device('cuda')` to `torch.device('cpu')` to ensure compatibility with the current execution environment.
    *   Updated `load_state_dict` calls to use `map_location=torch.device('cpu')`.

3. Agent & Algorithm Modifications (GMOCAT-modif/function/GCAT.py & agents/GCATAgent.py)
----------------------------------------------------------------------------------------
*   **Adaptive Diversity Weight:**
    *   Modified `GCATAgent.py`:
        *   Updated `Memory` class to store `coverages`.
        *   In `collecting_data_update_model`, calculated current coverage per step and stored it in memory.
        *   Passed coverage data to the `optimize_model` function.
    *   Modified `GCAT.py` (`ActorCritic` & `GCAT` classes):
        *   Updated `update` and `optimize_model` signatures to accept `b_coverages`.
        *   In the loss calculation, the weight for the diversity objective (second component of `morl_weights`) is now dynamic:
            *   `Effective Weight = Base Weight * (1.0 + 2.0 * (1.0 - Coverage))`
            *   This prioritizes diversity significantly when coverage is low (< 50%) and standardizes it as coverage increases.

4. Infrastructure & Analysis
----------------------------
*   **New Analysis Script (`analyze_results.py`):**
    *   Created a script to parse training logs.
    *   Generates a `coverage_curve.png` plot showing the progression of concept coverage over the test steps.
*   **Dependency Fixes:**
    *   Patched `dgl` library files (`dist_graph.py`, `graph_services.py`, `partition.py`) to remove dependencies on `graphbolt` which caused conflicts with newer `torchdata` versions.
    *   Resolved `sklearn` and `pandas` missing dependencies.
*   **Configuration (`train_gcat.sh`):**
    *   Updated to target the `dbekt22` dataset.
    *   Configured to use the `NCD` model.
    *   Adjusted batch sizes and epochs for the verification environment.

Summary of Results
------------------
The implemented changes successfully drove the model to achieve a concept coverage of approximately **90.9%** in preliminary runs (exceeding the 70% target). The termination logic now respects model uncertainty (< 0.01 variance) rather than just score stability.
